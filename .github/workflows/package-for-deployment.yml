name: "Package a SAM app and upload to S3 for secure pipeline deployment in multiple AWS accounts"

on:
  workflow_call:
    inputs:
      cris: {required: true, type: string}
      environment: {required: true, type: string}

jobs:
  config:
    name: Config
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Print CRIs
        shell: bash
        env:
          CRIS: ${{ inputs.cris }}
        run: echo "$CRIS"

  badges:
    name: Get badges
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      badges: ${{ steps.badges.outputs.values }}
    steps:
      - name: Pull repository
        uses: actions/checkout@v4

      - name: Get badges
        id: badges
        uses: ./.github/actions/map-dictionary
        with:
          dictionary: ${{ toJSON(vars) }}
          key-filter: _ENABLED$
          key-transform: ^(.*)_ENABLED$
          value-map: true=ðŸš€ | false=âœ‹

  publish:
    needs: badges
    name: Publish
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      fail-fast: false
      matrix:
        cri: ${{ fromJSON(inputs.cris) }} # from CRI names
        include:
          - {cri: ADDRESS, name: Address}
          - {cri: CHECK_HMRC, name: "Check HMRC"}
    steps:
      - name: Print
        shell: bash
        run: echo
