AWSTemplateFormatVersion: "2010-09-09"
Transform:
  - AWS::Serverless-2016-10-31
  - AWS::LanguageExtensions
Description: "Digital Identity IPV CRI common API"
Metadata:
  cfn-lint:
    config:
      ignore_checks:
        - W8003
        - E3031
        - E3033
        - E1020

Parameters:
  CodeSigningConfigArn:
    Type: String
    Default: "none"
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
  Environment:
    Description: "The environment type"
    Type: "String"
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
    ConstraintDescription: must be dev, build, staging, integration or production
  PermissionsBoundary:
    Description: "The ARN of the permissions boundary to apply when creating IAM roles"
    Type: String
    Default: "none"
  AuditEventNamePrefix:
    Description: "The audit event name prefix"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/common-cri-parameters/AuditEventNamePrefix"
  CriIdentifier:
    Description: "The unique credential issuer identifier"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/common-cri-parameters/CriIdentifier"
  TxmaStackName:
    Description: "The stack containing the TXMA infrastructure"
    Type: String
    Default: txma-infrastructure
  LambdaDeploymentPreference:
    Description: "Specifies the configuration to enable gradual Lambda deployments. This value is picked up from the LambdaCanaryDeployment on the pipeline "
    Type: String
    Default: AllAtOnce

Conditions:
  UseCodeSigningConfigArn:
    Fn::Not:
      - Fn::Equals:
          - !Ref CodeSigningConfigArn
          - "none"
  AddJavaProvisionedConcurrency: !Not
    - !Equals
      - !FindInMap [JavaProvisionedConcurrencyMapping, !Ref CriIdentifier, !Ref Environment]
      -  0
  AddTSProvisionedConcurrency: !Not
    - !Equals
      - !FindInMap [TSProvisionedConcurrencyMapping, !Ref CriIdentifier, !Ref Environment]
      -  0
  IsStubEnvironment: !Or
    - !Equals [!Ref Environment, dev]
    - !Equals [!Ref Environment, build]
    - !Equals [!Ref Environment, staging]
    - !Equals [!Ref Environment, integration]
  IsIpvCore3rdPartyStubEnvironment: !Equals
    - !Ref Environment
    - staging
  IsProdLikeEnvironment: !Or
    - !Equals [!Ref Environment, staging]
    - !Equals [!Ref Environment, integration]
    - !Equals [!Ref Environment, production]
  IsProdEnvironment: !Equals
    - !Ref Environment
    - production
  IsDevEnvironment: !Equals
    - !Ref Environment
    - dev
  IsDevPlatformDeploy: !Equals
    - !FindInMap [CriVpcMapping, !Ref CriIdentifier, !Ref Environment]
    - "di-devplatform-deploy"
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"
  IsCSLSDisabled: !Not
      - !Equals [!Ref Environment, "dev"]
  UseNewCSLSDestinationArn: !Or
    - !Equals [!Ref CriIdentifier, "di-ipv-cri-kbv-hmrc-api"]
    - !Equals [!Ref CriIdentifier, "di-ipv-cri-check-hmrc-api"]
  UseCanaryDeploymentAlarms: !Not [ !Equals [ !Ref LambdaDeploymentPreference, AllAtOnce ]]

Globals:
  Function:
    VpcConfig:
      SecurityGroupIds: !If
        - IsDevPlatformDeploy
        - [!ImportValue cri-vpc-AWSServicesEndpointSecurityGroupId]
        - [!ImportValue cri-vpc-LambdaSecurityGroup]
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    CodeSigningConfigArn: !If
      - UseCodeSigningConfigArn
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    Timeout: 30 # seconds
    Tracing: Active
    MemorySize: !FindInMap [MemorySizeMapping, Environment, !Ref "Environment"]
    Architectures:
      - arm64
    Environment:
      Variables:
        JAVA_TOOL_OPTIONS: -XX:+TieredCompilation -XX:TieredStopAtLevel=1
        AWS_STACK_NAME: !Sub ${AWS::StackName}
        POWERTOOLS_LOG_LEVEL: INFO
        POWERTOOLS_METRICS_NAMESPACE: !Ref CriIdentifier
        SQS_AUDIT_EVENT_PREFIX: !Ref AuditEventNamePrefix
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_CONNECTION_BASE_URL: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_CLUSTER_ID: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_TENANT: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: "true"


Mappings:

  CorePublicSigningJwksEnabled:
    di-ipv-cri-address-api:
      dev: true
      build: true
      staging: true
      integration: true
      production: true
    di-ipv-cri-fraud-api:
      dev: true
      build: true
      staging: true
      integration: false
      production: false
    di-ipv-cri-kbv-api:
      dev: true
      build: true
      staging: true
      integration: true
      production: true
    di-ipv-cri-dl-api:
      dev: true
      build: true
      staging: true
      integration: false
      production: false
    di-ipv-cri-passport-api:
      dev: true
      build: true
      staging: true
      integration: true
      production: true
    di-ipv-cri-kbv-hmrc-api:
      dev: false
      build: false
      staging: false
      integration: false
      production: false
    di-ipv-cri-check-hmrc-api:
      dev: true
      build: true
      staging: true
      integration: true
      production: true

  CoreJwksEndpoint:
    Environment:
      dev: https://api.identity.staging.account.gov.uk/.well-known/jwks.json
      build: https://api.identity.staging.account.gov.uk/.well-known/jwks.json
      staging: https://api.identity.staging.account.gov.uk/.well-known/jwks.json
      integration: https://api.identity.integration.account.gov.uk/.well-known/jwks.json
      production: https://api.identity.account.gov.uk/.well-known/jwks.json

  StubJwksEndpoint:
    di-ipv-cri-address-api:
      dev: https://test-resources.review-a.dev.account.gov.uk/.well-known/jwks.json
      build: https://test-resources.review-a.build.account.gov.uk/.well-known/jwks.json
      staging: https://test-resources.review-a.staging.account.gov.uk/.well-known/jwks.json
      integration: https://test-resources.review-a.integration.account.gov.uk/.well-known/jwks.json
    di-ipv-cri-fraud-api:
      dev: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      build: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      staging: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      integration: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
    di-ipv-cri-kbv-api:
      dev: https://test-resources.review-k.dev.account.gov.uk/.well-known/jwks.json
      build: https://test-resources.review-k.build.account.gov.uk/.well-known/jwks.json
      staging: https://test-resources.review-k.staging.account.gov.uk/.well-known/jwks.json
      integration: https://test-resources.review-k.integration.account.gov.uk/.well-known/jwks.json
    di-ipv-cri-dl-api:
      dev: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      build: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      staging: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      integration: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
    di-ipv-cri-passport-api:
      dev: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      build: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      staging: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      integration: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
    di-ipv-cri-kbv-hmrc-api:
      dev: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      build: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      staging: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
      integration: https://cri.core.stubs.account.gov.uk/.well-known/jwks.json
    di-ipv-cri-check-hmrc-api:
      dev: https://test-resources.review-hc.dev.account.gov.uk/.well-known/jwks.json
      build: https://test-resources.review-hc.build.account.gov.uk/.well-known/jwks.json
      staging: https://test-resources.review-hc.staging.account.gov.uk/.well-known/jwks.json
      integration: https://test-resources.review-hc.integration.account.gov.uk/.well-known/jwks.json

  EnvironmentConfiguration:
    dev:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    build:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    staging:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    integration:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    production:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables

  MemorySizeMapping:
    Environment:
      dev: 2048
      build: 3072
      staging: 2048
      integration: 2048
      production: 3072

  SessionTtlMapping:
    Environment:
      dev: 7200 # 2 hours
      build: 7200 # 2 hours
      staging: 7200 # 2 hours
      integration: 7200 # 2 hours
      production: 7200 # 2 hours

# Use key rotation aliases in session decryption
  KeyRotationMapping:
    di-ipv-cri-address-api:
      dev: "true"
      build: "true"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-fraud-api:
      dev: "true"
      build: "true"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-kbv-api:
      dev: "true"
      build: "true"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-dl-api:
      dev: "true"
      build: "false"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-passport-api:
      dev: "true"
      build: "true"
      staging: "true"
      integration: "true"
      production: "true"
    di-ipv-cri-kbv-hmrc-api:
      dev: "false"
      build: "false"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-check-hmrc-api:
      dev: "true"
      build: "true"
      staging: "false"
      integration: "false"
      production: "false"

  # Enable fall back with key rotation aliases in session decryption
  KeyRotationLegacyFallBackMapping:
    di-ipv-cri-address-api:
      dev: "false"
      build: "false"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-fraud-api:
      dev: "false"
      build: "true"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-kbv-api:
      dev: "true"
      build: "true"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-dl-api:
      dev: "false"
      build: "false"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-passport-api:
      dev: "false"
      build: "false"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-kbv-hmrc-api:
      dev: "false"
      build: "false"
      staging: "false"
      integration: "false"
      production: "false"
    di-ipv-cri-check-hmrc-api:
      dev: "true"
      build: "true"
      staging: "false"
      integration: "false"
      production: "false"

  # TS functions Only 0 = off
  TSProvisionedConcurrencyMapping:
    di-ipv-cri-address-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-fraud-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-kbv-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-dl-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-passport-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-kbv-hmrc-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-check-hmrc-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0

  # CANNOT be >= 1 with JavaSnapStart enabled - (Enables per cri&env role out)
  JavaProvisionedConcurrencyMapping:
    di-ipv-cri-address-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-fraud-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-kbv-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-dl-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-passport-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-kbv-hmrc-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0
    di-ipv-cri-check-hmrc-api:
      dev: 0
      build: 0
      staging: 0
      integration: 0
      production: 0

  # CANNOT be used with JavaProvisionedConcurrency - Java functions only (Enables per cri&env role out)
  # Permitted values : PublishedVersions or None
  JavaSnapStartMapping:
    di-ipv-cri-address-api:
      dev: PublishedVersions
      build: PublishedVersions
      staging: PublishedVersions
      integration: PublishedVersions
      production: PublishedVersions
    di-ipv-cri-fraud-api:
      dev: PublishedVersions
      build: PublishedVersions
      staging: PublishedVersions
      integration: PublishedVersions
      production: PublishedVersions
    di-ipv-cri-kbv-api:
      dev: None
      build: None
      staging: None
      integration: None
      production: None
    di-ipv-cri-dl-api:
      dev: PublishedVersions
      build: PublishedVersions
      staging: PublishedVersions
      integration: PublishedVersions
      production: PublishedVersions
    di-ipv-cri-passport-api:
      dev: PublishedVersions
      build: PublishedVersions
      staging: PublishedVersions
      integration: PublishedVersions
      production: PublishedVersions
    di-ipv-cri-kbv-hmrc-api:
      dev: None
      build: None
      staging: None
      integration: None
      production: None
    di-ipv-cri-check-hmrc-api:
      dev: None
      build: None
      staging: None
      integration: None
      production: None

  CriVpcMapping:
    di-ipv-cri-address-api:
      dev: "di-ipv-cri-pipeline-deployment"
      build: "di-ipv-cri-pipeline-deployment"
      staging: "di-ipv-cri-pipeline-deployment"
      integration: "di-ipv-cri-pipeline-deployment"
      production: "di-ipv-cri-pipeline-deployment"
    di-ipv-cri-fraud-api:
      dev: "di-ipv-cri-pipeline-deployment"
      build: "di-ipv-cri-pipeline-deployment"
      staging: "di-ipv-cri-pipeline-deployment"
      integration: "di-ipv-cri-pipeline-deployment"
      production: "di-ipv-cri-pipeline-deployment"
    di-ipv-cri-kbv-api:
      dev: "di-ipv-cri-pipeline-deployment"
      build: "di-ipv-cri-pipeline-deployment"
      staging: "di-ipv-cri-pipeline-deployment"
      integration: "di-ipv-cri-pipeline-deployment"
      production: "di-ipv-cri-pipeline-deployment"
    di-ipv-cri-dl-api:
      dev: "di-ipv-cri-pipeline-deployment"
      build: "di-ipv-cri-pipeline-deployment"
      staging: "di-ipv-cri-pipeline-deployment"
      integration: "di-ipv-cri-pipeline-deployment"
      production: "di-ipv-cri-pipeline-deployment"
    di-ipv-cri-passport-api:
      dev: "di-devplatform-deploy"
      build: "di-devplatform-deploy"
      staging: "di-devplatform-deploy"
      integration: "di-devplatform-deploy"
      production: "di-devplatform-deploy"
    di-ipv-cri-kbv-hmrc-api:
      dev: "di-devplatform-deploy"
      build: "di-devplatform-deploy"
      staging: "di-devplatform-deploy"
      integration: "di-devplatform-deploy"
      production: "di-devplatform-deploy"
    di-ipv-cri-check-hmrc-api:
      dev: "di-devplatform-deploy"
      build: "di-devplatform-deploy"
      staging: "di-devplatform-deploy"
      integration: "di-devplatform-deploy"
      production: "di-devplatform-deploy"

  CriAudienceMapping:
    di-ipv-cri-address-api:
      dev: "https://review-a.dev.account.gov.uk"
      build: "https://review-a.build.account.gov.uk"
      staging: "https://review-a.staging.account.gov.uk"
      integration: "https://review-a.integration.account.gov.uk"
      production: "https://review-a.account.gov.uk"
    di-ipv-cri-fraud-api:
      dev: "https://review-f.dev.account.gov.uk"
      build: "https://review-f.build.account.gov.uk"
      staging: "https://review-f.staging.account.gov.uk"
      integration: "https://review-f.integration.account.gov.uk"
      production: "https://review-f.account.gov.uk"
    di-ipv-cri-kbv-api:
      dev: "https://review-k.dev.account.gov.uk"
      build: "https://review-k.build.account.gov.uk"
      staging: "https://review-k.staging.account.gov.uk"
      integration: "https://review-k.integration.account.gov.uk"
      production: "https://review-k.account.gov.uk"
    di-ipv-cri-dl-api:
      dev: "https://review-d.dev.account.gov.uk"
      build: "https://review-d.build.account.gov.uk"
      staging: "https://review-d.staging.account.gov.uk"
      integration: "https://review-d.integration.account.gov.uk"
      production: "https://review-d.account.gov.uk"
    di-ipv-cri-passport-api:
      dev: "https://review-p.dev.account.gov.uk"
      build: "https://review-p.build.account.gov.uk"
      staging: "https://review-p.staging.account.gov.uk"
      integration: "https://review-p.integration.account.gov.uk"
      production: "https://review-p.account.gov.uk"
    di-ipv-cri-kbv-hmrc-api:
      dev: "https://review-hk.dev.account.gov.uk"
      build: "https://review-hk.build.account.gov.uk"
      staging: "https://review-hk.staging.account.gov.uk"
      integration: "https://review-hk.integration.account.gov.uk"
      production: "https://review-hk.account.gov.uk"
    di-ipv-cri-check-hmrc-api:
      dev: "https://review-hc.dev.account.gov.uk"
      build: "https://review-hc.build.account.gov.uk"
      staging: "https://review-hc.staging.account.gov.uk"
      integration: "https://review-hc.integration.account.gov.uk"
      production: "https://review-hc.account.gov.uk"

  IPVCoreStubAwsBuildIssuerMapping:
    Environment:
      dev: "https://cri.core.build.stubs.account.gov.uk"
      build: "https://cri.core.build.stubs.account.gov.uk"
      staging: "https://cri.core.build.stubs.account.gov.uk"
      integration: "https://cri.core.build.stubs.account.gov.uk"

  IPVCoreStubAwsProdIssuerMapping:
    Environment:
      dev: "https://cri.core.stubs.account.gov.uk"
      build: "https://cri.core.stubs.account.gov.uk"
      staging: "https://cri.core.stubs.account.gov.uk"
      integration: "https://cri.core.stubs.account.gov.uk"

  IPVCoreStubIssuerMapping:
    Environment:
      dev: "https://di-ipv-core-stub.london.cloudapps.digital"
      build: "https://di-ipv-core-stub.london.cloudapps.digital"
      staging: "https://di-ipv-core-stub.london.cloudapps.digital"
      integration: "https://di-ipv-core-stub.london.cloudapps.digital"

  IPVCoreStubPreProdAwsBuildIssuerMapping:
    Environment:
      production: "https://cri-preprod.core.build.stubs.account.gov.uk"

  IPVCoreStubPreProdIssuerMapping:
    Environment:
      production: "https://cri-preprod.core.stubs.account.gov.uk"

  IPVCore1IssuerMapping:
    Environment:
      staging: "https://identity.staging.account.gov.uk"
      integration: "https://identity.integration.account.gov.uk"
      production: "https://identity.account.gov.uk"

  IPVCoreStubAwsBuildPublicSigningJwkBase64Mapping:
    Environment:
      dev: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"
      build: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"
      staging: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"
      integration: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"

  IPVCoreStubPublicSigningJwkBase64Mapping:
    Environment:
      dev: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"
      build: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"
      staging: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"
      integration: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"

  IPVCoreStubPreProdAwsBuildPublicSigningJwkBase64Mapping:
    Environment:
      production: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"

  IPVCoreStubPreProdPublicSigningJwkBase64Mapping:
    Environment:
      production: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"

  IPVCore1PublicSigningJwkBase64Mapping:
    Environment:
      staging: "eyJrdHkiOiJFQyIsImNydiI6IlAtMjU2IiwieCI6ImtlMVRNRnFNb0Z5eHg1eXpOdFFRbGw0dk9yeHZUdFBKQ0huUzRqOHpoMlUiLCJ5IjoicURLX0g4QXpKS2FIbU1zaHg5TGp2LTB0ek5rV2EtSkVHUzJtZHRKUjFPQSJ9"
      integration: "eyJrdHkiOiJFQyIsImNydiI6IlAtMjU2IiwieCI6IkJUUWdWQjU0RE9JcDU0eGRVSVg0SGtUX3pCdjZHdVdMV1RUTkdxMk15dEkiLCJ5IjoiTFFRamx5ZEtOMUhXZFJQcFBpalJObEJrbi1qaDgzZzBBUmIyNms2WVh1byJ9"
      production: "eyJrdHkiOiJFQyIsImNydiI6IlAtMjU2IiwieCI6IlVQdlU1TlBtRUxyV2lXU01WZkREN0c4dTNFSllyeXFQSVo0Nlc5TUFsUmMiLCJ5Ijoicjc3RjItS1BocHZUSUdFV2d0NVNtYXZTdkJVSENxV1V4RDZSR19GSkhWayJ9"

  IPVCoreStubAwsProdRedirectURIMapping:
    Environment:
      dev: "https://cri.core.stubs.account.gov.uk/callback"
      build: "https://cri.core.stubs.account.gov.uk/callback"
      staging: "https://cri.core.stubs.account.gov.uk/callback"
      integration: "https://cri.core.stubs.account.gov.uk/callback"

  IPVCoreStubAwsBuildRedirectURIMapping:
    Environment:
      dev: "https://cri.core.build.stubs.account.gov.uk/callback"
      build: "https://cri.core.build.stubs.account.gov.uk/callback"
      staging: "https://cri.core.build.stubs.account.gov.uk/callback"
      integration: "https://cri.core.build.stubs.account.gov.uk/callback"

  IPVCoreStubRedirectURIMapping:
    Environment:
      dev: "https://di-ipv-core-stub.london.cloudapps.digital/callback"
      build: "https://di-ipv-core-stub.london.cloudapps.digital/callback"
      staging: "https://di-ipv-core-stub.london.cloudapps.digital/callback"
      integration: "https://di-ipv-core-stub.london.cloudapps.digital/callback"

  IPVCoreStubPreProdAwsBuildRedirectURIMapping:
    Environment:
      production: "https://cri-preprod.core.build.stubs.account.gov.uk/callback"

  IPVCoreStubPreProdRedirectURIMapping:
    Environment:
      production: "https://cri-preprod.core.stubs.account.gov.uk/callback"

  IPVCore1RedirectURIMapping:
    di-ipv-cri-address-api:
      staging: "https://identity.staging.account.gov.uk/credential-issuer/callback?id=address"
      integration: "https://identity.integration.account.gov.uk/credential-issuer/callback?id=address"
      production: "https://identity.account.gov.uk/credential-issuer/callback?id=address"
    di-ipv-cri-fraud-api:
      staging: "https://identity.staging.account.gov.uk/credential-issuer/callback?id=fraud"
      integration: "https://identity.integration.account.gov.uk/credential-issuer/callback?id=fraud"
      production: "https://identity.account.gov.uk/credential-issuer/callback?id=fraud"
    di-ipv-cri-kbv-api:
      staging: "https://identity.staging.account.gov.uk/credential-issuer/callback?id=kbv"
      integration: "https://identity.integration.account.gov.uk/credential-issuer/callback?id=kbv"
      production: "https://identity.account.gov.uk/credential-issuer/callback?id=kbv"
    di-ipv-cri-dl-api:
      staging: "https://identity.staging.account.gov.uk/credential-issuer/callback?id=drivingLicence"
      integration: "https://identity.integration.account.gov.uk/credential-issuer/callback?id=drivingLicence"
      production: "https://identity.account.gov.uk/credential-issuer/callback?id=drivingLicence"
    di-ipv-cri-passport-api:
      staging: "https://identity.staging.account.gov.uk/credential-issuer/callback?id=ukPassport"
      integration: "https://identity.integration.account.gov.uk/credential-issuer/callback?id=ukPassport"
      production: "https://identity.account.gov.uk/credential-issuer/callback?id=ukPassport"
    di-ipv-cri-check-hmrc-api:
      staging: "https://identity.staging.account.gov.uk/credential-issuer/callback?id=nino"
      integration: "https://identity.integration.account.gov.uk/credential-issuer/callback?id=nino"
      production: "https://identity.account.gov.uk/credential-issuer/callback?id=nino"
    di-ipv-cri-kbv-hmrc-api:
      staging: "https://identity.staging.account.gov.uk/credential-issuer/callback?id=hmrcKbv"
      integration: "https://identity.integration.account.gov.uk/credential-issuer/callback?id=hmrcKbv"
      production: "https://identity.account.gov.uk/credential-issuer/callback?id=hmrcKbv"

  VerifiableCredentialIssuerMapping:
    di-ipv-cri-address-api:
      dev: "https://review-a.dev.account.gov.uk"
      build: "https://review-a.build.account.gov.uk"
      staging: "https://review-a.staging.account.gov.uk"
      integration: "https://review-a.integration.account.gov.uk"
      production: "https://review-a.account.gov.uk"
    di-ipv-cri-fraud-api:
      dev: "https://review-f.dev.account.gov.uk"
      build: "https://review-f.build.account.gov.uk"
      staging: "https://review-f.staging.account.gov.uk"
      integration: "https://review-f.integration.account.gov.uk"
      production: "https://review-f.account.gov.uk"
    di-ipv-cri-kbv-api:
      dev: "https://review-k.dev.account.gov.uk"
      build: "https://review-k.build.account.gov.uk"
      staging: "https://review-k.staging.account.gov.uk"
      integration: "https://review-k.integration.account.gov.uk"
      production: "https://review-k.account.gov.uk"
    di-ipv-cri-dl-api:
      dev: "https://review-d.dev.account.gov.uk"
      build: "https://review-d.build.account.gov.uk"
      staging: "https://review-d.staging.account.gov.uk"
      integration: "https://review-d.integration.account.gov.uk"
      production: "https://review-d.account.gov.uk"
    di-ipv-cri-passport-api:
      dev: "https://review-p.dev.account.gov.uk"
      build: "https://review-p.build.account.gov.uk"
      staging: "https://review-p.staging.account.gov.uk"
      integration: "https://review-p.integration.account.gov.uk"
      production: "https://review-p.account.gov.uk"
    di-ipv-cri-kbv-hmrc-api:
      dev: "https://review-hk.dev.account.gov.uk"
      build: "https://review-hk.build.account.gov.uk"
      staging: "https://review-hk.staging.account.gov.uk"
      integration: "https://review-hk.integration.account.gov.uk"
      production: "https://review-hk.account.gov.uk"
    di-ipv-cri-check-hmrc-api:
      dev: "https://review-hc.dev.account.gov.uk"
      build: "https://review-hc.build.account.gov.uk"
      staging: "https://review-hc.staging.account.gov.uk"
      integration: "https://review-hc.integration.account.gov.uk"
      production: "https://review-hc.account.gov.uk"

  CanaryDeploymentapigatewayidMapping:
    di-ipv-cri-check-hmrc-api:
      privateapigwname: "check-hmrc-cri-api-private"
      publicapigwname: "check-hmrc-cri-api-public"
    di-ipv-cri-address-api:
      privateapigwname: "address-cri-api-v1-PrivateAddressApi"
      publicapigwname: "address-cri-api-v1-PublicAddressApi"
    di-ipv-cri-kbv-api:
      privateapigwname: "kbv-cri-private-kbv-cri-api-v1"
      publicapigwname: "kbv-cri-kbv-cri-api-v1"
    di-ipv-cri-kbv-hmrc-api:
      privateapigwname: "kbv-hmrc-cri-api-PrivateApiGatewayId-placehonder"
      publicapigwname: "kbv-hmrc-cri-api-PublicApiGatewayId-placehonder"
    di-ipv-cri-passport-api:
      privateapigwname: "ipv-cri-passport-api-PrivateUKPassportApi"
      publicapigwname: "ipv-cri-passport-api-PublicUKPassportApi"
    di-ipv-cri-dl-api:
      privateapigwname: "dl-cri-api-v1-PrivateDLApi"
      publicapigwname: "dl-cri-api-v1-PublicDLApi"
    di-ipv-cri-fraud-api:
      privateapigwname: "fraud-cri-api-v1-PrivateFraudApi"
      publicapigwname: "fraud-cri-api-v1-PublicFraudApi"


Resources:

  #########################
  # Common OAuth Lambdas  #
  #########################

  SessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-SessionFunction"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref SessionFunctionLambdaErrors, !Ref SessionFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      CodeUri: ../../session
      Handler: uk.gov.di.ipv.cri.common.api.handler.SessionHandler::handleRequest
      Runtime: java17
      Layers:
        - !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:JAVA_LAYER}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
      VpcConfig:
        SubnetIds: !If
          - IsDevPlatformDeploy
          - [
              !ImportValue cri-vpc-ProtectedSubnetIdA,
              !ImportValue cri-vpc-ProtectedSubnetIdB,
            ]
          - !Split [",", !ImportValue cri-vpc-PrivateSubnets]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-session"
          SQS_AUDIT_EVENT_QUEUE_URL:
            Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueUrl
          ENV_VAR_FEATURE_FLAG_KEY_ROTATION: !FindInMap [ KeyRotationMapping, !Ref CriIdentifier, !Ref Environment ]
          ENV_VAR_FEATURE_CONSUME_PUBLIC_JWK: !FindInMap [ CorePublicSigningJwksEnabled, !Ref CriIdentifier, !Ref Environment ]
          ENV_VAR_FEATURE_FLAG_KEY_ROTATION_LEGACY_KEY_FALLBACK: !FindInMap [ KeyRotationLegacyFallBackMapping, !Ref CriIdentifier, !Ref Environment ]
      AutoPublishAlias: live
      AutoPublishAliasAllProperties: true
      SnapStart:
        ApplyOn: !FindInMap [JavaSnapStartMapping, !Ref CriIdentifier, !Ref Environment]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName: !Ref SessionTable
        - DynamoDBWritePolicy:
            TableName: !Ref PersonIdentityTable
        - SQSSendMessagePolicy:
            QueueName:
              Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueName
        - KMSDecryptPolicy:
            KeyId: !ImportValue core-infrastructure-CriDecryptionKey1Id
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTtl"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/KBVCriAudience"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/AuthRequestKmsEncryptionKeyId"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/PersonIdentityTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/verifiable-credential/issuer"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/clients/*"
        - Statement:
            - Effect: Allow
              Action:
                - sqs:sendmessage
              Resource:
                - !Sub "arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:*"
        - Statement:
            - Sid: auditEventQueueKmsEncryptionKeyPermission
              Effect: Allow
              Action:
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource:
                Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueEncryptionKeyArn
      ProvisionedConcurrencyConfig:
        !If
        - AddJavaProvisionedConcurrency
        - ProvisionedConcurrentExecutions: !FindInMap [JavaProvisionedConcurrencyMapping, !Ref CriIdentifier, !Ref Environment]
        - !Ref AWS::NoValue

  SessionFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${SessionFunction}"
      RetentionInDays: 30

  SessionFunctionLogGroupSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsCSLSDisabled
    Properties:
      DestinationArn: !If
        - UseNewCSLSDestinationArn
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref SessionFunctionLogGroup

  SessionFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-SessionFunctionLambdaErrors"
      AlarmDescription: !Sub "Trigger an alarm when lambda errors occurs"
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-SessionFunction:live"
        - Name: ExecutedVersion
          Value: !Sub SessionFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  SessionFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions:  
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      AlarmName: !Sub "${AWS::StackName}-SessionFunctionCanary5xxErrors"
      AlarmDescription: !Sub "SessionFunction Lambda returning 5xx response."
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: POST
        - Name: ApiName
          Value: !FindInMap [CanaryDeploymentapigatewayidMapping, !Ref CriIdentifier, privateapigwname]
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /session
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 2
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  SessionFunctionTS:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-SessionFunctionTS"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref SessionFunctionTSLambdaErrors, !Ref SessionFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      CodeUri: ../../lambdas
      Handler: session-handler.lambdaHandler
      Runtime: nodejs22.x
      Layers:
        - !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
      VpcConfig:
        SubnetIds: !If
          - IsDevPlatformDeploy
          - [
              !ImportValue cri-vpc-ProtectedSubnetIdA,
              !ImportValue cri-vpc-ProtectedSubnetIdB,
            ]
          - !Split [",", !ImportValue cri-vpc-PrivateSubnets]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-sessionTS"
          SQS_AUDIT_EVENT_QUEUE_URL:
            Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueUrl
          CRI_IDENTIFIER: !Sub "${CriIdentifier}"
          ENV_VAR_FEATURE_FLAG_KEY_ROTATION: !FindInMap [ KeyRotationMapping, !Ref CriIdentifier, !Ref Environment ]
          ENV_VAR_FEATURE_CONSUME_PUBLIC_JWK: !FindInMap [ CorePublicSigningJwksEnabled, !Ref CriIdentifier, !Ref Environment]
          ENV_VAR_FEATURE_FLAG_KEY_ROTATION_LEGACY_KEY_FALLBACK: !FindInMap [ KeyRotationLegacyFallBackMapping, !Ref CriIdentifier, !Ref Environment ]
      AutoPublishAlias: live
      AutoPublishAliasAllProperties: true
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName: !Ref SessionTable
        - DynamoDBWritePolicy:
            TableName: !Ref PersonIdentityTable
        - SQSSendMessagePolicy:
            QueueName:
              Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueName
        - KMSDecryptPolicy:
            KeyId: !ImportValue core-infrastructure-CriDecryptionKey1Id
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${AWS::StackName}/clients/*"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameters
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTtl"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/KBVCriAudience"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/AuthRequestKmsEncryptionKeyId"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/PersonIdentityTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/verifiable-credential/issuer"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CriIdentifier}/evidence-properties"
        - Statement:
            - Sid: auditEventQueueKmsEncryptionKeyPermission
              Effect: Allow
              Action:
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource:
                Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueEncryptionKeyArn
      ProvisionedConcurrencyConfig:
        !If
        - AddTSProvisionedConcurrency
        - ProvisionedConcurrentExecutions: !FindInMap [TSProvisionedConcurrencyMapping, !Ref CriIdentifier, !Ref Environment]
        - !Ref AWS::NoValue
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "node18"
        Sourcemap: true # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - src/handlers/session-handler.ts
        External:
          - "@aws-sdk/*"

  SessionFunctionTSLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${SessionFunctionTS}"
      RetentionInDays: 30

  SessionFunctionLogGroupSubscriptionFilterCSLSTS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsCSLSDisabled
    Properties:
      DestinationArn: !If
        - UseNewCSLSDestinationArn
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref SessionFunctionTSLogGroup

  SessionFunctionTSLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-SessionFunctionTSLambdaErrors"
      AlarmDescription: !Sub "Trigger an alarm when lambda errors occurs"
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-SessionTSFunction:live"
        - Name: ExecutedVersion
          Value: !Sub SessionFunctionTS.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AuthorizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-AuthorizationFunction"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref AuthorizationFunctionLambdaErrors, !Ref AuthorizationFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      CodeUri: ../../authorization
      Handler: uk.gov.di.ipv.cri.common.api.handler.AuthorizationHandler::handleRequest
      Runtime: java17
      Layers:
        - !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:JAVA_LAYER}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
      VpcConfig:
        SubnetIds: !If
          - IsDevPlatformDeploy
          - [
              !ImportValue cri-vpc-PrivateSubnetIdA,
              !ImportValue cri-vpc-PrivateSubnetIdB,
            ]
          - !Split [",", !ImportValue cri-vpc-PrivateSubnets]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-authorization"
      AutoPublishAlias: live
      AutoPublishAliasAllProperties: true
      SnapStart:
        ApplyOn: !FindInMap [JavaSnapStartMapping, !Ref CriIdentifier, !Ref Environment]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName: !Ref SessionTable
        - DynamoDBWritePolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTableName"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/clients/*"
      ProvisionedConcurrencyConfig:
        !If
        - AddJavaProvisionedConcurrency
        - ProvisionedConcurrentExecutions: !FindInMap [JavaProvisionedConcurrencyMapping, !Ref CriIdentifier, !Ref Environment]
        - !Ref AWS::NoValue

  AuthorizationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AuthorizationFunction}"
      RetentionInDays: 30

  AuthorizationFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunctionLambdaErrors"
      AlarmDescription: !Sub "Trigger an alarm when lambda errors occurs"
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-AuthorizationFunction:live"
        - Name: ExecutedVersion
          Value: !Sub AuthorizationFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AuthorizationFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunctionCanary5xxErrors"
      AlarmDescription: !Sub "AuthorizationFunction Lambda returning 5xx response."
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: GET
        - Name: ApiName
          Value: !FindInMap [CanaryDeploymentapigatewayidMapping, !Ref CriIdentifier, privateapigwname]
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /authorization
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 2
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AuthorizationFunctionTS:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-AuthorizationFunctionTS"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref AuthorizationFunctionTSLambdaErrors, !Ref AuthorizationFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      CodeUri: ../../lambdas
      Handler: authorization-handler.lambdaHandler
      Runtime: nodejs22.x
      Layers:
        - !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
      VpcConfig:
        SubnetIds: !If
          - IsDevPlatformDeploy
          - [
              !ImportValue cri-vpc-PrivateSubnetIdA,
              !ImportValue cri-vpc-PrivateSubnetIdB,
            ]
          - !Split [",", !ImportValue cri-vpc-PrivateSubnets]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-authorizationTS"
      AutoPublishAlias: live
      AutoPublishAliasAllProperties: true
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName: !Ref SessionTable
        - DynamoDBWritePolicy:
            TableName: !Ref SessionTable
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${AWS::StackName}/clients/*"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameters
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTableName"
      ProvisionedConcurrencyConfig:
        !If
        - AddTSProvisionedConcurrency
        - ProvisionedConcurrentExecutions: !FindInMap [TSProvisionedConcurrencyMapping, !Ref CriIdentifier, !Ref Environment]
        - !Ref AWS::NoValue
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "node18"
        Sourcemap: true # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - src/handlers/authorization-handler.ts
        External:
          - "@aws-sdk/*"

  AuthorizationFunctionTSLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AuthorizationFunctionTS}"
      RetentionInDays: 30

  AuthorizationFunctionLogGroupSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsCSLSDisabled
    Properties:
      DestinationArn: !If
        - UseNewCSLSDestinationArn
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref AuthorizationFunctionLogGroup

  AuthorizationFunctionLogGroupSubscriptionFilterCSLSTS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsCSLSDisabled
    Properties:
      DestinationArn: !If
        - UseNewCSLSDestinationArn
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref AuthorizationFunctionTSLogGroup

  AuthorizationFunctionTSLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunctionTSLambdaErrors"
      AlarmDescription: !Sub "Trigger an alarm when lambda errors occurs"
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-AuthorizationFunctionTS:live"
        - Name: ExecutedVersion
          Value: !Sub AuthorizationFunctionTS.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AccessTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-AccessTokenFunction"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref AccessTokenFunctionLambdaErrors, !Ref AccessTokenFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      CodeUri: ../../accesstoken
      Handler: uk.gov.di.ipv.cri.common.api.handler.AccessTokenHandler::handleRequest
      Runtime: java17
      Layers:
        - !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:JAVA_LAYER}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
      VpcConfig:
        SubnetIds: !If
          - IsDevPlatformDeploy
          - [
              !ImportValue cri-vpc-ProtectedSubnetIdA,
              !ImportValue cri-vpc-ProtectedSubnetIdB,
            ]
          - !Split [",", !ImportValue cri-vpc-PrivateSubnets]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-access-token"
          ENV_VAR_FEATURE_CONSUME_PUBLIC_JWK: !FindInMap [ CorePublicSigningJwksEnabled, !Ref CriIdentifier, !Ref Environment ]
      AutoPublishAlias: live
      AutoPublishAliasAllProperties: true
      SnapStart:
        ApplyOn: !FindInMap [JavaSnapStartMapping, !Ref CriIdentifier, !Ref Environment]
      Policies:
        - DynamoDBReadPolicy:
            TableName:
              Ref: SessionTable
        - DynamoDBWritePolicy:
            TableName:
              Ref: SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTtl"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/clients/*"
      ProvisionedConcurrencyConfig:
        !If
        - AddJavaProvisionedConcurrency
        - ProvisionedConcurrentExecutions: !FindInMap [JavaProvisionedConcurrencyMapping, !Ref CriIdentifier, !Ref Environment]
        - !Ref AWS::NoValue

  AccessTokenFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AccessTokenFunctionLambdaErrors"
      AlarmDescription: !Sub "Trigger an alarm when lambda errors occurs"
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-AccessTokenFunction:live"
        - Name: ExecutedVersion
          Value: !Sub AccessTokenFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AccessTokenFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      AlarmName: !Sub "${AWS::StackName}-AccessTokenFunctionCanary5xxErrors"
      AlarmDescription: !Sub "AccessTokenFunction Lambda returning 5xx response."
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: POST
        - Name: ApiName
          Value: !FindInMap [CanaryDeploymentapigatewayidMapping, !Ref CriIdentifier, publicapigwname]
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /token
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 2
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AccessTokenFunctionTS:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-AccessTokenFunctionTS"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref AccessTokenFunctionTSLambdaErrors, !Ref AccessTokenFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      Handler: access-token-handler.lambdaHandler
      CodeUri: ../../lambdas
      Runtime: nodejs22.x
      Layers:
        - !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
      VpcConfig:
        SubnetIds: !If
          - IsDevPlatformDeploy
          - [
              !ImportValue cri-vpc-ProtectedSubnetIdA,
              !ImportValue cri-vpc-ProtectedSubnetIdB,
            ]
          - !Split [",", !ImportValue cri-vpc-PrivateSubnets]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-access-token-2"
          ENV_VAR_FEATURE_CONSUME_PUBLIC_JWK: !FindInMap [ CorePublicSigningJwksEnabled, !Ref CriIdentifier, !Ref Environment]
      AutoPublishAlias: live
      AutoPublishAliasAllProperties: true
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Ref: SessionTable
        - DynamoDBWritePolicy:
            TableName:
              Ref: SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameters
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTtl"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/clients/*"
      ProvisionedConcurrencyConfig:
        !If
        - AddTSProvisionedConcurrency
        - ProvisionedConcurrentExecutions: !FindInMap [TSProvisionedConcurrencyMapping, !Ref CriIdentifier, !Ref Environment]
        - !Ref AWS::NoValue
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "node18"
        Sourcemap: true # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - src/handlers/access-token-handler.ts
        External:
          - "@aws-sdk/*"

  AccessTokenTSFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AccessTokenFunctionTS}"
      RetentionInDays: 30

  AccessTokenTSPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt AccessTokenFunctionTS.Arn
      Principal: apigateway.amazonaws.com

  AccessTokenTSAliasPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AccessTokenFunctionTS.Alias
      Principal: apigateway.amazonaws.com

  AccessTokenFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AccessTokenFunction}"
      RetentionInDays: 30

  AccessTokenFunctionLogGroupSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsCSLSDisabled
    Properties:
      DestinationArn: !If
        - UseNewCSLSDestinationArn
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython" 
      FilterPattern: ""
      LogGroupName: !Ref AccessTokenFunctionLogGroup

  AccessTokenFunctionLogGroupSubscriptionFilterCSLSTS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsCSLSDisabled
    Properties:
      DestinationArn: !If
        - UseNewCSLSDestinationArn
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
        - "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython" 
      FilterPattern: ""
      LogGroupName: !Ref AccessTokenTSFunctionLogGroup

  AccessTokenFunctionTSLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AccessTokenFunctionTSLambdaErrors"
      AlarmDescription: !Sub "Trigger an alarm when lambda errors occurs"
      ActionsEnabled: true
      AlarmActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      OKActions: 
        - !Sub arn:aws:sns:eu-west-2:${AWS::AccountId}:platform-alarm-topic-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-AccessTokenFunctionTS:live"
        - Name: ExecutedVersion
          Value: !Sub AccessTokenFunctionTS.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  SessionTable:
    Type: "AWS::DynamoDB::Table"
    Properties:
      TableName: !Sub "session-${AWS::StackName}"
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "sessionId"
          AttributeType: "S"
        - AttributeName: "authorizationCode"
          AttributeType: "S"
        - AttributeName: "accessToken"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "sessionId"
          KeyType: "HASH"
      GlobalSecondaryIndexes:
        - IndexName: "authorizationCode-index"
          KeySchema:
            - AttributeName: "authorizationCode"
              KeyType: "HASH"
          Projection:
            NonKeyAttributes:
              - "sessionId"
              - "redirectUri"
              - "clientId"
            ProjectionType: "INCLUDE"
        - IndexName: "access-token-index"
          KeySchema:
            - AttributeName: "accessToken"
              KeyType: "HASH"
          Projection:
            NonKeyAttributes:
              - "sessionId"
              - "subject"
            ProjectionType: "INCLUDE"
        - IndexName: "access-token-index-with-event-data"
          KeySchema:
            - AttributeName: "accessToken"
              KeyType: "HASH"
          Projection:
            NonKeyAttributes:
              - "sessionId"
              - "subject"
              - "persistentSessionId"
              - "clientSessionId"
              - "clientIpAddress"
              - "clientId"
            ProjectionType: "INCLUDE"
      TimeToLiveSpecification:
        AttributeName: expiryDate
        Enabled: true

  PersonIdentityTable:
    Type: "AWS::DynamoDB::Table"
    Properties:
      TableName: !Sub "person-identity-${AWS::StackName}"
      BillingMode: "PAY_PER_REQUEST"
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "sessionId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "sessionId"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: expiryDate
        Enabled: true

  ParameterSessionTableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/SessionTableName"
      Value: !Sub session-${AWS::StackName}
      Type: String
      Description: session dynamodb table name

  ParameterPersonIdentityTableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/PersonIdentityTableName"
      Value: !Sub person-identity-${AWS::StackName}
      Type: String
      Description: person identity dynamodb table name

  SessionTtlParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/SessionTtl"
      Type: String
      Value: !FindInMap [SessionTtlMapping, Environment, !Ref "Environment"]
      Description: default time to live for a session item (seconds)

  IPVCoreStubAwsProdAuthenticationAlgParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  IPVCoreStubAwsBuildAuthenticationAlgParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  IPVCoreStubAuthenticationAlgParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  IPVCoreStubPreProdAwsBuildAuthenticationAlgParameter:
    Condition: IsProdLikeEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod-aws-build/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  IPVCoreStubPreProdAuthenticationAlgParameter:
    Condition: IsProdLikeEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  IPVCore1AuthenticationAlgParameter:
    Condition: IsProdLikeEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  IPVCoreStubAwsProdAudienceParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAwsBuildAudienceParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAudienceParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubPreProdAwsBuildAudienceParameter:
    Condition: IsProdEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod-aws-build/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubPreProdAudienceParameter:
    Condition: IsProdEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCore1AudienceParameter:
    Condition: IsProdLikeEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAwsProdIssuerParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod/jwtAuthentication/issuer"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubAwsProdIssuerMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubAwsBuildIssuerParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build/jwtAuthentication/issuer"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubAwsBuildIssuerMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubIssuerParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub/jwtAuthentication/issuer"
      Type: String
      Value:
        !FindInMap [IPVCoreStubIssuerMapping, Environment, !Ref "Environment"]

  IPVCoreStubPreProdAwsBuildIssuerParameter:
    Condition: IsProdEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod-aws-build/jwtAuthentication/issuer"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubPreProdAwsBuildIssuerMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubPreProdIssuerParameter:
    Condition: IsProdEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod/jwtAuthentication/issuer"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubPreProdIssuerMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCore1IssuerParameter:
    Condition: IsProdLikeEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core/jwtAuthentication/issuer"
      Type: String
      Value: !FindInMap [IPVCore1IssuerMapping, Environment, !Ref "Environment"]

  IPVCoreStubAwsProdPublicSigningJwkBase64Parameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubAwsBuildPublicSigningJwkBase64Mapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubAwsBuildPublicSigningJwkBase64Parameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubAwsBuildPublicSigningJwkBase64Mapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubPublicSigningJwkBase64Parameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubPublicSigningJwkBase64Mapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubPreProdAwsBuildPublicSigningJwkBase64Parameter:
    Condition: IsProdEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod-aws-build/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubPreProdAwsBuildPublicSigningJwkBase64Mapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubPreProdPublicSigningJwkBase64Parameter:
    Condition: IsProdEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubPreProdPublicSigningJwkBase64Mapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCore1PublicSigningJwkBase64Parameter:
    Condition: IsProdLikeEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value:
        !FindInMap [
          IPVCore1PublicSigningJwkBase64Mapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubAwsProdRedirectURIParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod/jwtAuthentication/redirectUri"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubAwsProdRedirectURIMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubAwsBuildRedirectURIParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build/jwtAuthentication/redirectUri"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubAwsBuildRedirectURIMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubRedirectURIParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub/jwtAuthentication/redirectUri"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubRedirectURIMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubPreProdAwsBuildRedirectURIParameter:
    Condition: IsProdEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod-aws-build/jwtAuthentication/redirectUri"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubPreProdAwsBuildRedirectURIMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCoreStubPreProdRedirectURIParameter:
    Condition: IsProdEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod/jwtAuthentication/redirectUri"
      Type: String
      Value:
        !FindInMap [
          IPVCoreStubPreProdRedirectURIMapping,
          Environment,
          !Ref "Environment",
        ]

  IPVCore1RedirectURIParameter:
    Condition: IsProdLikeEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core/jwtAuthentication/redirectUri"
      Type: String
      Value:
        !FindInMap [
          IPVCore1RedirectURIMapping,
          !Ref CriIdentifier,
          !Ref Environment,
        ]

  IPVCoreStubAWSProdJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [StubJwksEndpoint, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAWSBuildJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [StubJwksEndpoint, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [StubJwksEndpoint, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubPreProdAWSBuildJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod-aws-build/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [StubJwksEndpoint, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubPreProdJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-pre-prod/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [StubJwksEndpoint, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAWSHeadlessJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-headless/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [StubJwksEndpoint, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAWSProdThirdPartyJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod_3rdparty/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [StubJwksEndpoint, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAWSBuildThirdPartyJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build_3rdparty/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [StubJwksEndpoint, !Ref CriIdentifier, !Ref Environment]

  IPVCoreThirdPartyStubsJwksEndpointParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-3rd-party-stubs/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [CoreJwksEndpoint, Environment, !Ref Environment]

  IPVCoreJwksEndpointParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core/jwtAuthentication/jwksEndpoint"
      Type: String
      Value:
        !FindInMap [CoreJwksEndpoint, Environment, !Ref Environment]

  AuthRequestKmsEncryptionKeyIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/AuthRequestKmsEncryptionKeyId"
      Type: String
      Value: !ImportValue core-infrastructure-CriDecryptionKey1Id
      Description: The (KMS) encryption key identifier for decrypting authorisation requests

  VerifiableCredentialIssuerParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/verifiable-credential/issuer"
      Type: String
      Value:
        !FindInMap [
          VerifiableCredentialIssuerMapping,
          !Ref CriIdentifier,
          !Ref Environment,
        ]
      Description: Issuer of the Verifiable Credential

  VerifiableCredentialKmsSigningKeyParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/verifiableCredentialKmsSigningKeyId"
      Type: String
      Value: !ImportValue core-infrastructure-CriVcSigningKey1Id
      Description: Verifiable Credential Key Id

  SessionFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt SessionFunction.Arn
      Principal: apigateway.amazonaws.com

  SessionFunctionAliasPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SessionFunction.Alias
      Principal: apigateway.amazonaws.com

  SessionFunctionTSPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt SessionFunctionTS.Arn
      Principal: apigateway.amazonaws.com

  SessionFunctionTSAliasPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SessionFunctionTS.Alias
      Principal: apigateway.amazonaws.com

  AccessTokenFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt AccessTokenFunction.Arn
      Principal: apigateway.amazonaws.com

  AccessTokenFunctionAliasPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AccessTokenFunction.Alias
      Principal: apigateway.amazonaws.com

  AuthorizationFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt AuthorizationFunction.Arn
      Principal: apigateway.amazonaws.com

  AuthorizationFunctionAliasPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AuthorizationFunction.Alias
      Principal: apigateway.amazonaws.com

  AuthorizationFunctionTSPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt AuthorizationFunctionTS.Arn
      Principal: apigateway.amazonaws.com

  AuthorizationFunctionTSAliasPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AuthorizationFunctionTS.Alias
      Principal: apigateway.amazonaws.com

  LoggingKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"

  CreateAuthCodeFunction:
    Type: AWS::Serverless::Function
    Condition: IsDevEnvironment
    Properties:
      FunctionName: !Sub "${AWS::StackName}-CreateAuthCodeFunction"
      CodeUri: ../../lambdas
      Handler: create-auth-code-handler.lambdaHandler
      Runtime: nodejs22.x
      Layers:
        - !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
      VpcConfig:
        SubnetIds: !If
          - IsDevPlatformDeploy
          - [
              !ImportValue cri-vpc-PrivateSubnetIdA,
              !ImportValue cri-vpc-PrivateSubnetIdB,
            ]
          - !Split [",", !ImportValue cri-vpc-PrivateSubnets]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-create-auth-code"
      Policies:
        - DynamoDBWritePolicy:
            TableName:
              Ref: SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameters
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/SessionTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/clients/*"
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "node18"
        Sourcemap: true # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - src/handlers/create-auth-code-handler.ts
        External:
          - "@aws-sdk/*"

  CreateAuthCodeFunctionPermission:
    Type: AWS::Lambda::Permission
    Condition: IsDevEnvironment
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt CreateAuthCodeFunction.Arn
      Principal: apigateway.amazonaws.com

  PreMergeDevOnlyApi:
    Type: AWS::Serverless::Api
    Condition: IsDevEnvironment
    Properties:
      Description: CRI API Gateway for pre-merge testing in dev only
      MethodSettings:
        - LoggingLevel: INFO
          ResourcePath: "/*"
          HttpMethod: "*"
          ThrottlingRateLimit: 5
          ThrottlingBurstLimit: 10
      AccessLogSetting:
        DestinationArn: !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${PreMergeDevOnlyApiAccessLogGroup}"
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip":"$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path":"$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLatency":"$context.responseLatency",
          "responseLength":"$context.responseLength"
          }
      Name: !Sub "common-lambdas-${AWS::StackName}"
      StageName: !Ref Environment
      DefinitionBody:
        openapi: "3.0.1" # workaround to get `sam validate` to work
        paths: # workaround to get `sam validate` to work
          /never-created:
            options: {} # workaround to get `sam validate` to work
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: "./pre-merge-api.yaml"
      OpenApiVersion: 3.0.1
      EndpointConfiguration:
        Type: REGIONAL

  PreMergeDevOnlyApiAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: IsDevEnvironment
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-${PreMergeDevOnlyApi}-private-AccessLogs
      RetentionInDays: 30

  ##################################################################################################
  # ipv-core-3rd-party-stubs clientId configuration (real ipv-core + real cri's + 3rd-party-stubs Only Staging)
  #################################################################################################
  IPVCore3rdPartyStubsAudienceParameter:
    Condition: IsIpvCore3rdPartyStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-3rd-party-stubs/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCore3rdPartyStubsPublicSigningJwkBase64Parameter:
    Condition: IsIpvCore3rdPartyStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-3rd-party-stubs/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value:
        !FindInMap [IPVCore1PublicSigningJwkBase64Mapping, Environment,!Ref "Environment"]

  IPVCore3rdPartyStubsIssuerParameter:
    Condition: IsIpvCore3rdPartyStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-3rd-party-stubs/jwtAuthentication/issuer"
      Type: String
      Value: !FindInMap [IPVCore1IssuerMapping, Environment, !Ref "Environment"]

  IPVCore3rdPartyStubsRedirectURIParameter:
    Condition: IsIpvCore3rdPartyStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-3rd-party-stubs/jwtAuthentication/redirectUri"
      Type: String
      Value:
        !FindInMap [IPVCore1RedirectURIMapping, !Ref CriIdentifier, !Ref Environment ]

  IPVCore3rdPartyStubsAuthenticationAlgParameter:
    Condition: IsIpvCore3rdPartyStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-3rd-party-stubs/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  ##################################################################################################
  # ipv-core-stub-aws-headless clientId configuration
  #################################################################################################
  IPVCoreStubAwsHeadlessAudienceParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-headless/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAwsHeadlessPublicSigningJwkBase64Parameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-headless/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"

  IPVCoreStubAwsHeadlessIssuerParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-headless/jwtAuthentication/issuer"
      Type: String
      Value: !Join
        - ''
        - - 'https://test-resources.'
          - !Select
            - 1
            - !Split
              - 'https://'
              - !FindInMap
                - VerifiableCredentialIssuerMapping
                - !Ref CriIdentifier
                - !Ref Environment

  IPVCoreStubAwsHeadlessRedirectURIParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-headless/jwtAuthentication/redirectUri"
      Type: String
      Value: !Join
        - ''
        - - 'https://test-resources.'
          - !Select
            - 1
            - !Split
              - 'https://'
              - !FindInMap
                - VerifiableCredentialIssuerMapping
                - !Ref CriIdentifier
                - !Ref Environment
          - '/callback'

  IPVCoreStubAwsHeadlessAuthenticationAlgParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-headless/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  ##################################################################################################
  # ipv-core-stub-aws-prod_3rdparty clientId configuration
  #################################################################################################
  IPVCoreStubAwsProd3rdPartyAudienceParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod_3rdparty/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAwsProd3rdPartyPublicSigningJwkBase64Parameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod_3rdparty/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"

  IPVCoreStubAwsProd3rdPartyIssuerParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod_3rdparty/jwtAuthentication/issuer"
      Type: String
      Value: "https://cri-3rdparty.core.stubs.account.gov.uk"

  IPVCoreStubAwsProd3rdPartyRedirectURIParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod_3rdparty/jwtAuthentication/redirectUri"
      Type: String
      Value: "https://cri-3rdparty.core.stubs.account.gov.uk/callback"

  IPVCoreStubAwsProd3rdPartyAuthenticationAlgParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-prod_3rdparty/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  ##################################################################################################
  # ipv-core-stub-aws-build_3rdparty clientId configuration
  #################################################################################################
  IPVCoreStubAwsBuild3rdPartyAudienceParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build_3rdparty/jwtAuthentication/audience"
      Type: String
      Value:
        !FindInMap [CriAudienceMapping, !Ref CriIdentifier, !Ref Environment]

  IPVCoreStubAwsBuild3rdPartyPublicSigningJwkBase64Parameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build_3rdparty/jwtAuthentication/publicSigningJwkBase64"
      Type: String
      Value: "ewogICAgImt0eSI6ICJFQyIsCiAgICAidXNlIjogInNpZyIsCiAgICAiY3J2IjogIlAtMjU2IiwKICAgICJraWQiOiAiaXB2LWNvcmUtc3R1Yi0yLWZyb20tbWtqd2sub3JnIiwKICAgICJ4IjogImszOXVLYWNTdWtRQnJNWnJIRFRCVVpzbGl2cFhLRE5aVGc2aW5DSHdyTGMiLAogICAgInkiOiAiOEY4TG5RN3dHOWh4c1Q0YXgwQXR5N2lNR0l5aVlfWUdwM19xSVp6S28xQSIsCiAgICAiYWxnIjogIkVTMjU2Igp9"

  IPVCoreStubAwsBuild3rdPartyIssuerParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build_3rdparty/jwtAuthentication/issuer"
      Type: String
      Value: "https://cri-3rdparty.core.build.stubs.account.gov.uk"

  IPVCoreStubAwsBuild3rdPartyRedirectURIParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build_3rdparty/jwtAuthentication/redirectUri"
      Type: String
      Value: "https://cri-3rdparty.core.build.stubs.account.gov.uk/callback"

  IPVCoreStubAwsBuild3rdPartyAuthenticationAlgParameter:
    Condition: IsStubEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/clients/ipv-core-stub-aws-build_3rdparty/jwtAuthentication/authenticationAlg"
      Type: String
      Value: ES256

  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codedeploy.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRoleForLambda
      PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]

Outputs:
  PreMergeDevOnlyApiId:
    Condition: IsDevEnvironment
    Description: API GatewayID of the dev-only common lambdas API
    Value: !Ref PreMergeDevOnlyApi
