openapi: 3.0.1
info:
  title: "Test harness"
  version: "1.0"

paths:
  /callback:
    get:
      security:
        - sigv4Reference: [ ]
      summary: handles Callback initiated by ipv-core-stub-aws-headless
      parameters:
        - name: authorizationCode
          in: query
          required: true
          description: authorizationCode generated by CRI
          schema:
            type: string
      responses:
        "200":
          description: Successfully issued credentials
          content:
            application/jwt:
              schema:
                type: string
                format: application/jwt
                pattern: ^([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_\-\+\/=]+)$
                example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
        "400":
          description: Invalid request
        "401":
          description: Unauthorized request
      x-amazon-apigateway-request-validator: "Validate both"
      x-amazon-apigateway-integration:
        httpMethod: "POST"
        uri:
          Fn::Sub: arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CallbackFunction.Arn}/invocations
        responses:
          default:
            statusCode: "200"
        passthroughBehavior: "when_no_match"
        contentHandling: "CONVERT_TO_TEXT"
        type: "aws_proxy"
  /events:
    get:
      security:
        - sigv4Reference: [ ]
      description: Retrieve events from DynamoDB events table. Used for testing purposes only.
      parameters:
        - name: partitionKey
          in: query
          required: true
          description: Partition key to use in events table query.
          schema:
            type: string
        - name: sortKey
          in: query
          required: true
          description: Sort key to use in events table query.
          schema:
            type: string
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: object
        400:
          description: Bad request, missing partitionKey or sortKey
        500:
          description: Internal server error
      x-amazon-apigateway-request-validator: Validate both
      x-amazon-apigateway-integration:
        httpMethod: POST
        passThroughBehavior: when_no_templates
        type: aws
        credentials:
          Fn::Sub: ${AuditEventsTableRole.Arn}
        uri:
          Fn::Sub:
            arn:aws:apigateway:${AWS::Region}:dynamodb:action/Query
        requestTemplates:
          application/json:
            Fn::Sub:
              - >
                #set($partitionKey = $input.params('partitionKey'))
                #set($sortKey = $input.params('sortKey'))
                {
                  "TableName": "${table}",
                  "KeyConditionExpression": "partitionKey = :partitionKey AND begins_with(sortKey, :sortKey)",
                  "ExpressionAttributeValues": {
                    ":partitionKey": {
                      "S": "$partitionKey"
                    },
                    ":sortKey": {
                      "S": "$sortKey"
                    }
                  },
                  "ProjectionExpression": "partitionKey, sortKey, event"
                }
              - table:
                  Ref: AuditEventsTable
        responses:
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                $input.json('$.Items')

x-amazon-apigateway-request-validators:
  Validate both:
    validateRequestBody: true
    validateRequestParameters: true

x-amazon-apigateway-policy:
  Version: "2012-10-17"
  Statement:
    - Effect: "Deny"
      Principal:
        AWS:  "*"
      Action: "execute-api:Invoke"
      Resource: "execute-api:/*"
      Condition:
        StringNotEquals:
          "aws:PrincipalAccount":
            - "${AWS::AccountId}"

components:
  securitySchemes:
    sigv4Reference:
      type: apiKey
      name: Authorization
      in: header
      x-amazon-apigateway-authtype: awsSigv4
